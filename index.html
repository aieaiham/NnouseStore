<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Nnouse Store</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<style>
  /* --- 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… (Ø§Ù„Ø«Ø§Ø¨ØªØ© - Ù„Ù… ØªØªØºÙŠØ±) --- */
  :root {
    --bg-color: #f3f3f3; 
    --card-bg: #ffffff;
    --text-main: #333333;
    --gold: #c9a24d; 
    --border: #e0e0e0;
    --shadow: 0 4px 10px rgba(0,0,0,0.06);
  }

  body.dark-mode {
    --bg-color: #181818;
    --card-bg: #242424;
    --text-main: #eeeeee;
    --border: #444;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
  body { background: var(--bg-color); color: var(--text-main); min-height: 100vh; overflow-x: hidden; transition: 0.3s; padding-bottom: 80px; }
  button { border: none; outline: none; cursor: pointer; transition: 0.2s; }
  button:active { transform: scale(0.95); }
  input, textarea { outline: none; }
  .hidden { display: none !important; }

  /* --- Ø§Ù„ØµÙØ­Ø§Øª --- */
  .page { display: none; padding: 20px; animation: fadeIn 0.4s; }
  .page.active { display: block; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

  /* --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ (Intro) --- */
  .intro-wrap { 
    height: 100vh; display: flex; flex-direction: column; 
    justify-content: center; align-items: center; text-align: center; 
    background: var(--bg-color); position: fixed; top:0; left:0; width:100%; z-index: 2000;
  }
  .intro-title { font-size: 32px; color: var(--gold); font-weight: bold; margin-bottom: 10px; }
  .intro-sub { font-size: 14px; opacity: 0.7; margin-bottom: 40px; }
  .enter-btn { 
    padding: 12px 50px; background: var(--gold); color: #fff; 
    border-radius: 50px; font-size: 18px; font-weight: bold; 
    box-shadow: 0 5px 20px rgba(201, 162, 77, 0.3); 
  }

  /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± --- */
  .header-area { text-align: center; padding: 40px 20px 20px; position: relative; }
  .header-area h1 { font-size: 28px; color: var(--gold); font-weight: 700; margin-bottom: 5px; }
  .header-area p { font-size: 13px; color: #888; margin-bottom: 25px; }

  .menu-toggle { position: absolute; top: 30px; left: 20px; background: none; padding: 5px; }
  .menu-toggle svg { width: 28px; height: 28px; stroke: var(--gold); }
  .back-btn { position: absolute; top: 30px; right: 20px; background: none; font-size: 24px; color: var(--text-main); }

  /* --- Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« --- */
  .search-wrap { max-width: 550px; margin: 0 auto 30px; position: relative; width: 95%; }
  .search-inp { 
    width: 100%; padding: 12px 45px 12px 20px; border-radius: 50px; 
    border: 2px solid var(--gold); background: #fff; font-size: 14px; 
    box-shadow: 0 2px 5px rgba(201, 162, 77, 0.1); text-align: right; color: #333; 
  }
  .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--gold); pointer-events: none; }

  /* --- Ø§Ù„Ø´Ø¨ÙƒØ© ÙˆØ§Ù„ÙƒØ±ÙˆØª --- */
  .grid-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; padding: 0 10px; }

  .item-card { 
    background: var(--card-bg); width: 180px; border-radius: 20px; padding: 10px; 
    box-shadow: var(--shadow); display: flex; flex-direction: column; position: relative;
    border: 1px solid transparent; transition: 0.3s;
  }
  .item-card.dragging { opacity: 0.5; border: 2px dashed var(--gold); }

  .img-area { 
    width: 100%; aspect-ratio: 2/3; /* Ø¹Ø§Ù…ÙˆØ¯ÙŠ */
    background: #f9f9f9; border-radius: 15px; 
    overflow: hidden; margin-bottom: 10px; position: relative; display: flex; align-items: center; justify-content: center; 
  }
  .img-area img { width: 100%; height: 100%; object-fit: cover; }

  /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù† */
  .admin-btns { position: absolute; top: 5px; left: 5px; display: flex; flex-direction: column; gap: 5px; opacity: 0; z-index: 10; }
  .item-card:hover .admin-btns { opacity: 1; }
  .icon-btn { width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.9); box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; font-size: 14px; color: #333; }

  .card-title { font-size: 13px; font-weight: 600; text-align: center; margin-bottom: 5px; min-height: 20px; color: var(--text-main); }
  .card-title[contenteditable="true"]:focus { background: #eee; border-radius: 4px; outline: none; }

  .price-lbl { color: var(--gold); font-weight: bold; font-size: 14px; text-align: center; display: block; margin-bottom: 8px; }
  .price-edit { width: 100%; padding: 4px; border: 1px solid var(--gold); border-radius: 6px; text-align: center; margin-bottom: 5px; font-weight: bold; background: var(--bg-color); color: var(--text-main); }

  /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø± */
  .visitor-tools { border-top: 1px solid var(--border); padding-top: 8px; margin-top: auto; }
  .qty-row { display: flex; justify-content: center; margin-bottom: 8px; align-items: center; gap: 5px; }
  .qty-label { font-size: 11px; opacity: 0.7; }
  .qty-input { width: 60px; text-align: center; border: 1px solid #ccc; border-radius: 8px; padding: 4px; font-weight: bold; background: var(--bg-color); color: var(--text-main); }
  .add-btn { width: 100%; background: var(--gold); color: #fff; padding: 8px; border-radius: 12px; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px; }

  /* Ø²Ø± Ø¥Ø¶Ø§ÙØ© ÙƒØ§Ø±Øª */
  .add-new-box { border: 2px dashed var(--gold); background: transparent; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 300px; width: 180px; border-radius: 20px; }

  /* --- Ø§Ù„Ø³Ù„Ø© ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª --- */
  .cart-wrap { max-width: 600px; margin: 0 auto; padding-bottom: 100px; }
  .cart-row, .support-card { display: flex; gap: 15px; background: var(--card-bg); padding: 15px; border-radius: 15px; margin-bottom: 10px; box-shadow: var(--shadow); align-items: center; }
  .cart-thumb { width: 60px; height: 60px; border-radius: 10px; object-fit: cover; border: 1px solid #eee; }
  .cart-details { flex: 1; }
  .cart-price { color: var(--gold); font-weight: bold; font-size: 14px; }
  
  .fixed-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--card-bg); padding: 15px 20px; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; z-index: 500; }
  .total-txt { font-size: 18px; font-weight: bold; color: var(--text-main); }
  .checkout-arrow { width: 50px; height: 50px; border-radius: 50%; background: var(--gold); color: #fff; font-size: 24px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(201, 162, 77, 0.4); }

  /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© */
  .float-cart { position: fixed; bottom: 20px; left: 20px; width: 55px; height: 55px; background: var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 800; color: #fff; cursor: pointer; }
  .badge { position: absolute; top: -5px; right: -5px; background: red; color: white; width: 20px; height: 20px; border-radius: 50%; font-size: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid #fff; }

  /* --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© --- */
  .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 998; display: none; }
  .overlay.active { display: block; } 
  
  .sidebar { position: fixed; top: 0; left: -280px; width: 260px; height: 100%; background: var(--card-bg); z-index: 999; transition: 0.3s; padding: 25px 20px; box-shadow: 5px 0 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 10px; }
  .sidebar.active { left: 0; }

  .profile-box { text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border); cursor: pointer; }
  .p-img { width: 70px; height: 70px; border-radius: 50%; border: 2px solid var(--gold); margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; background: #eee; }
  .p-img img { width: 100%; height: 100%; object-fit: cover; }

  .menu-link { 
    display: flex; align-items: center; justify-content: space-between; 
    padding: 12px; background: var(--bg-color); 
    border-radius: 10px; cursor: pointer; 
    font-weight: 600; color: var(--gold);
    border: 1px solid var(--gold);
  }
  .menu-link:hover { background: var(--gold); color: #fff; }
  
  /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª */
  .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; pointer-events: none; transition: 0.2s; }
  .modal.active { opacity: 1; pointer-events: auto; }
  .modal-content { background: var(--card-bg); width: 90%; max-width: 350px; padding: 25px; border-radius: 20px; text-align: center; }
  .inp-field, .txt-area { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; background: var(--bg-color); color: var(--text-main); }
  .txt-area { min-height: 100px; resize: none; }
  .btn-gold { width: 100%; padding: 12px; background: var(--gold); color: #fff; border-radius: 10px; font-weight: bold; margin-top: 10px; }

  .save-float { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: var(--gold); color: #fff; padding: 10px 30px; border-radius: 30px; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 900; }
  .toast { position: fixed; bottom: 50%; left: 50%; transform: translate(-50%, 50%); background: rgba(0,0,0,0.85); color: #fff; padding: 12px 25px; border-radius: 25px; font-size: 14px; z-index: 3000; display: none; }
  
  /* ÙƒØ§Ø±Øª Ø§Ù„Ø·Ù„Ø¨ ÙˆØ§Ù„Ø¯Ø¹Ù… */
  .order-box, .support-msg-box { background: var(--card-bg); padding: 15px; border-radius: 15px; margin-bottom: 10px; border: 1px solid var(--border); }
  .order-head { display: flex; justify-content: space-between; font-weight: bold; color: var(--gold); margin-bottom: 5px; }
  .whatsapp-link { background: #25D366; color: white; padding: 6px 12px; border-radius: 15px; text-decoration: none; font-size: 12px; display: inline-block; margin-top: 5px; }
  
  .support-txt { font-size: 14px; margin: 10px 0; line-height: 1.6; text-align: right; background: var(--bg-color); padding: 10px; border-radius: 10px; }
</style>
</head>
<body>

<div id="introPage" class="page active">
    <div class="intro-wrap">
        <h1 class="intro-title">Nnouse Store</h1>
        <p class="intro-sub">Photography & Art</p>
        <button class="enter-btn" onclick="showPage('storePage')">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ØªØ¬Ø±</button>
    </div>
</div>

<div id="storePage" class="page">
  <div class="header-area">
    <button class="menu-toggle" onclick="toggleSidebar()">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="2.5"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
    <h1>Nnouse Store</h1>
    <p>Photography & Art</p>
    <div class="search-wrap">
      <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input type="text" class="search-inp" id="searchBox" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª..." oninput="renderItems()">
    </div>
  </div>

  <div class="grid-container" id="grid"></div>
  
  <button id="saveBtn" class="save-float hidden" onclick="saveData()">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ğŸ’¾</button>

  <div class="float-cart" onclick="showPage('cartPage')">
    <span class="badge" id="floatBadge">0</span>
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
  </div>
</div>

<div id="cartPage" class="page">
  <div class="header-area">
    <button class="back-btn" onclick="showPage('storePage')">âœ</button>
    <h2>Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h2>
  </div>
  <div id="cartList" class="cart-wrap"></div>
  <div class="fixed-footer">
    <div class="total-txt">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <span id="grandTotal" style="color:var(--gold)">0 IQD</span></div>
    <button class="checkout-arrow" onclick="openModal('checkoutModal')">âœ”</button>
  </div>
</div>

<div id="ordersPage" class="page">
  <div class="header-area">
    <button class="back-btn" onclick="showPage('storePage')">âœ</button>
    <h2>ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h2>
  </div>
  <div id="ordersList" class="cart-wrap"></div>
</div>

<div id="adminSupportPage" class="page">
    <div class="header-area">
      <button class="back-btn" onclick="showPage('storePage')">âœ</button>
      <h2>ğŸ“¥ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„</h2>
    </div>
    <div id="supportMessagesList" class="cart-wrap"></div>
</div>

<div class="overlay" id="overlay" onclick="toggleSidebar()"></div>
<div class="sidebar" id="sidebar">
  <div class="profile-box" onclick="handleAuth()">
    <div class="p-img"><img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png"></div>
    <b id="adminLabel" style="color:var(--gold)">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</b>
    <div id="adminSub" style="font-size:12px; opacity:0.6">Ø§Ø¶ØºØ· Ù„Ù„Ø¯Ø®ÙˆÙ„</div>
  </div>

  <div class="menu-link" onclick="toggleDark()"><span>ğŸŒ™ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span></div>
  <div class="menu-link" onclick="showPage('cartPage'); toggleSidebar();"><span>ğŸ›’ Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</span></div>
  <div class="menu-link hidden" id="orderLink" onclick="showPage('ordersPage'); toggleSidebar();"><span>ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span></div>
  <div class="menu-link hidden" id="supportLinkAdmin" onclick="showPage('adminSupportPage'); toggleSidebar();"><span>ğŸ“¥ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„</span></div>
  <div class="menu-link" onclick="openModal('supportModal'); toggleSidebar();"><span>ğŸ§ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</span></div>
</div>

<div id="loginModal" class="modal">
  <div class="modal-content">
    <h3>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</h3>
    <input type="email" id="email" class="inp-field" placeholder="Email">
    <input type="password" id="pass" class="inp-field" placeholder="Password">
    <button class="btn-gold" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
    <button style="background:none; margin-top:10px; color:var(--text-main);" onclick="closeModal('loginModal')">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<div id="checkoutModal" class="modal">
  <div class="modal-content">
    <h3>Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø² ğŸ“</h3>
    <input type="text" id="cName" class="inp-field" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
    <input type="tel" id="cPhone" class="inp-field" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
    <input type="text" id="cAddr" class="inp-field" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
    <button class="btn-gold" onclick="submitOrder()">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø² âœ…</button>
    <button style="background:none; margin-top:10px; color:var(--text-main);" onclick="closeModal('checkoutModal')">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<div id="supportModal" class="modal">
    <div class="modal-content">
        <h3 style="color:var(--gold); margin-bottom:10px;">Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ ğŸ§</h3>
        <p style="font-size:13px; margin-bottom:15px; opacity:0.8; line-height:1.5;">Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ Ù†Ø¹ØªØ°Ø± Ø¹Ù† Ø£ÙŠ ØªÙ‚ØµÙŠØ±. Ù†Ø±Ø¬Ùˆ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù‡Ù†Ø§ ÙˆØ³ÙŠØªÙ… Ø­Ù„Ù‡Ø§ Ø¨Ø£Ø³Ø±Ø¹ ÙˆÙ‚Øª.</p>
        <textarea id="supportText" class="txt-area" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù‡Ù†Ø§..."></textarea>
        <button class="btn-gold" onclick="submitSupport()">Ø¥Ø±Ø³Ø§Ù„ ğŸ“¨</button>
        <button style="background:none; margin-top:10px; color:var(--text-main);" onclick="closeModal('supportModal')">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<div id="toast" class="toast">ØªÙ…</div>

<script>
  // --- Firebase Init ---
  const firebaseConfig = {
    apiKey: "AIzaSyA9VtZjv7ZlgHaNU8wgCYD_f7nqrzBHjOQ",
    authDomain: "nnousestore.firebaseapp.com",
    databaseURL: "https://nnousestore-default-rtdb.firebaseio.com",
    projectId: "nnousestore",
    storageBucket: "nnousestore.firebasestorage.app",
    messagingSenderId: "149315172289",
    appId: "1:149315172289"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const auth = firebase.auth();
  const dataRef = db.ref('nnouse_store_v6/items');
  const ordersRef = db.ref('nnouse_store_v6/orders');
  const supportRef = db.ref('nnouse_store_v6/support_tickets');

  let items = [];
  let cart = JSON.parse(localStorage.getItem('cart_v6') || '{}');
  let currentUser = null;
  let dragSrcIndex = null;

  // --- UI Functions ---
  function showPage(id) { 
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); 
    document.getElementById(id).classList.add('active'); 
    if(id==='cartPage') renderCart();
    if(id==='ordersPage') renderOrders();
    if(id==='adminSupportPage') renderSupportMessages();
  }

  function toggleSidebar() { 
    const side = document.getElementById('sidebar');
    const over = document.getElementById('overlay');
    const isActive = side.classList.contains('active');
    
    if(isActive) {
        side.classList.remove('active');
        over.classList.remove('active');
    } else {
        side.classList.add('active');
        over.classList.add('active');
    }
  }

  function openModal(id) { document.getElementById(id).classList.add('active'); }
  function closeModal(id) { document.getElementById(id).classList.remove('active'); }
  
  function showToast(msg) { 
    const t=document.getElementById('toast'); t.innerText=msg; t.style.display='block'; 
    setTimeout(()=>t.style.display='none', 2000); 
  }

  function toggleDark() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('dark', document.body.classList.contains('dark-mode'));
  }
  if(localStorage.getItem('dark')==='true') document.body.classList.add('dark-mode');

  // --- Auth ---
  auth.onAuthStateChanged(user => {
    currentUser = user;
    const lbl = document.getElementById('adminLabel');
    const sub = document.getElementById('adminSub');
    if(user) {
        lbl.innerText = "Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ (Ø£Ø¯Ù…Ù†)"; lbl.style.color = "green"; sub.innerText = user.email;
        document.getElementById('saveBtn').classList.remove('hidden');
        document.getElementById('orderLink').classList.remove('hidden');
        document.getElementById('supportLinkAdmin').classList.remove('hidden'); // Ø²Ø± ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„
    } else {
        lbl.innerText = "Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†"; lbl.style.color = "var(--gold)"; sub.innerText = "Ø§Ø¶ØºØ· Ù„Ù„Ø¯Ø®ÙˆÙ„";
        document.getElementById('saveBtn').classList.add('hidden');
        document.getElementById('orderLink').classList.add('hidden');
        document.getElementById('supportLinkAdmin').classList.add('hidden');
    }
    renderItems();
  });

  function handleAuth() { if(!currentUser) openModal('loginModal'); else if(confirm('Ø®Ø±ÙˆØ¬ØŸ')) auth.signOut(); }
  function login() { auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('pass').value).then(()=>{closeModal('loginModal'); showToast('ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„');}).catch(()=>showToast('Ø®Ø·Ø£')); }

  // --- Data ---
  dataRef.on('value', snap => { items = snap.val() || []; renderItems(); updateBadge(); });

  function saveData() {
    if(!currentUser) return;
    showToast('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...');
    const clean = items.filter(x => x && (x.img || x.desc !== 'Ø¬Ø¯ÙŠØ¯'));
    dataRef.set(clean).then(()=>showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…'));
  }

  // --- Render Store ---
  function renderItems() {
    const grid = document.getElementById('grid'); grid.innerHTML = '';
    const search = document.getElementById('searchBox').value.toLowerCase();
    const isAdmin = !!currentUser;

    items.forEach((item, index) => {
        if(search && !item.desc.toLowerCase().includes(search)) return;

        const card = document.createElement('div');
        card.className = 'item-card';
        card.dataset.index = index;
        if(isAdmin) { card.setAttribute('draggable', true); setupDrag(card); }

        let imgSrc = item.img ? item.img : '';
        let imgContent = imgSrc ? `<img src="${imgSrc}">` : '<span style="color:#ccc;font-size:30px">+</span>';

        card.innerHTML = `
            <div class="img-area">
                ${imgContent}
                ${isAdmin ? `<div class="admin-btns">
                    <button class="icon-btn" onclick="triggerImg(${index})">ğŸ“·</button>
                    <button class="icon-btn" onclick="delItem(${index})" style="color:red">ğŸ—‘ï¸</button>
                </div>` : ''}
            </div>
            
            ${isAdmin ? `<input type="number" class="price-edit" value="${item.price||0}" onchange="items[${index}].price=Number(this.value)">` : `<span class="price-lbl">${(item.price||0).toLocaleString()} IQD</span>`}
            
            <div class="card-title" contenteditable="${isAdmin}" onblur="items[${index}].desc=this.innerText">${item.desc||'Ù…Ù†ØªØ¬'}</div>
            
            ${!isAdmin ? `<div class="visitor-tools">
                <div class="qty-row">
                    <span class="qty-label">Ø§Ù„ÙƒÙ…ÙŠØ©:</span>
                    <input type="number" id="qty-${index}" class="qty-input" value="1" min="1">
                </div>
                <button class="add-btn" onclick="addCart(${index})">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø© ğŸ›’</button>
            </div>` : ''}
        `;
        grid.appendChild(card);
    });

    if(isAdmin) {
        const addDiv = document.createElement('div');
        addDiv.className = 'add-new-box';
        addDiv.innerHTML = '<span style="font-size:40px;color:var(--gold)">+</span>';
        addDiv.onclick = () => { items.push({desc:'Ø¬Ø¯ÙŠØ¯', price:0}); renderItems(); };
        grid.appendChild(addDiv);
    }
  }

  // --- Admin Logic ---
  function triggerImg(i) {
    const input = document.createElement('input'); input.type='file';
    input.onchange = e => {
        const f = e.target.files[0];
        if(f) {
            const r = new FileReader();
            r.onload = ev => { items[i].img = ev.target.result; renderItems(); showToast('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©'); };
            r.readAsDataURL(f);
        }
    }; input.click();
  }
  function delItem(i) { if(confirm('Ø­Ø°ÙØŸ')) { items.splice(i,1); renderItems(); } }
  
  function setupDrag(el) {
    el.addEventListener('dragstart', ()=>{ dragSrcIndex=Number(el.dataset.index); el.classList.add('dragging'); });
    el.addEventListener('dragend', ()=>{ el.classList.remove('dragging'); });
    el.addEventListener('dragover', e=>e.preventDefault());
    el.addEventListener('drop', ()=>{
        const target = Number(el.dataset.index);
        const temp = items[dragSrcIndex];
        items.splice(dragSrcIndex, 1);
        items.splice(target, 0, temp);
        renderItems();
    });
  }

  // --- Cart ---
  function addCart(i) {
    const qtyVal = parseInt(document.getElementById(`qty-${i}`).value) || 1;
    cart[i] = (cart[i]||0) + qtyVal;
    saveCart(); updateBadge(); showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
  }
  function saveCart() { localStorage.setItem('cart_v6', JSON.stringify(cart)); }
  function updateBadge() { document.getElementById('floatBadge').innerText = Object.keys(cart).length; }

  function renderCart() {
    const list = document.getElementById('cartList'); list.innerHTML = '';
    let total = 0;
    
    Object.keys(cart).forEach(i => {
        const item = items[i]; if(!item) return;
        const sub = item.price * cart[i]; total += sub;
        list.innerHTML += `
        <div class="cart-row">
            <img src="${item.img}" class="cart-thumb">
            <div class="cart-details">
                <b>${item.desc}</b><br>
                <small>${item.price.toLocaleString()} x ${cart[i]}</small><br>
                <span class="cart-price">${sub.toLocaleString()} IQD</span>
            </div>
            <button onclick="delete cart[${i}]; renderCart(); updateBadge();" style="color:red; background:none;">âœ•</button>
        </div>`;
    });
    
    if(Object.keys(cart).length===0) list.innerHTML='<div style="text-align:center;padding:40px;opacity:0.6">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</div>';
    document.getElementById('grandTotal').innerText = total.toLocaleString() + ' IQD';
  }

  // --- Orders ---
  function submitOrder() {
    const name = document.getElementById('cName').value;
    const phone = document.getElementById('cPhone').value;
    const addr = document.getElementById('cAddr').value;
    
    if(!name || !phone) { showToast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); return; }
    
    const order = {
        customer: { name, phone, addr },
        cart: cart,
        total: document.getElementById('grandTotal').innerText,
        date: new Date().toLocaleString()
    };
    
    ordersRef.push(order).then(() => {
        cart = {}; saveCart(); updateBadge();
        closeModal('checkoutModal');
        showToast('ØªÙ… Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­ âœ…');
        showPage('storePage');
    });
  }

  function renderOrders() {
    const list = document.getElementById('ordersList'); list.innerHTML = 'ØªØ­Ù…ÙŠÙ„...';
    ordersRef.on('value', snap => {
        list.innerHTML = '';
        const orders = snap.val();
        if(!orders) { list.innerHTML='Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª'; return; }
        
        Object.keys(orders).reverse().forEach(key => {
            const o = orders[key];
            let details = '';
            Object.keys(o.cart).forEach(idx => {
                if(items[idx]) details += `- ${items[idx].desc} (Ø¹Ø¯Ø¯ ${o.cart[idx]})<br>`;
            });
            
            let phoneClean = o.customer.phone.replace(/^0+/, '');
            
            list.innerHTML += `
            <div class="order-box">
                <div class="order-head"><span>${o.customer.name}</span> <small>${o.date}</small></div>
                <div style="font-size:13px; line-height:1.6">
                    ğŸ“ ${o.customer.phone}<br>
                    ğŸ“ ${o.customer.addr}<br>
                    ğŸ’° <b>${o.total}</b><hr style="margin:5px 0; border-top:1px dashed #ddd">
                    ${details}
                </div>
                <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center">
                    <a href="https://wa.me/964${phoneClean}" target="_blank" class="whatsapp-link">ØªÙˆØ§ØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨</a>
                    <button onclick="if(confirm('Ø­Ø°ÙØŸ')) ordersRef.child('${key}').remove()" style="color:red; background:none; font-size:12px">Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨</button>
                </div>
            </div>`;
        });
    });
  }

  // --- Support Logic (Ø¬Ø¯ÙŠØ¯) ---
  function submitSupport() {
      const msg = document.getElementById('supportText').value;
      if(!msg) return showToast("Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø£ÙˆÙ„Ø§Ù‹");
      
      supportRef.push({
          msg: msg,
          date: new Date().toLocaleString()
      }).then(() => {
          document.getElementById('supportText').value = "";
          closeModal('supportModal');
          showToast("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
      });
  }

  function renderSupportMessages() {
      const list = document.getElementById('supportMessagesList'); 
      list.innerHTML = 'ØªØ­Ù…ÙŠÙ„...';
      
      supportRef.on('value', snap => {
          list.innerHTML = '';
          const msgs = snap.val();
          if(!msgs) { list.innerHTML = '<div style="text-align:center;padding:30px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„</div>'; return; }
          
          Object.keys(msgs).reverse().forEach(key => {
              const m = msgs[key];
              list.innerHTML += `
              <div class="support-msg-box">
                  <div class="order-head"><span>Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</span> <small>${m.date}</small></div>
                  <div class="support-txt">${m.msg}</div>
                  <button onclick="if(confirm('ØªÙ… Ø§Ù„Ø­Ù„ØŸ')) supportRef.child('${key}').remove()" style="color:red; background:none; font-size:12px; margin-top:5px;">Ø­Ø°Ù (ØªÙ… Ø§Ù„Ø­Ù„)</button>
              </div>`;
          });
      });
  }
</script>
</body>
</html>